name: CI
on: [push, pull_request]

jobs:
  test:
    name: Test witx tools
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
    - uses: actions/checkout@v1
    - name: Install Rust (rustup)
      shell: bash
      run: rustup update stable --no-self-update && rustup default stable
      if: matrix.os != 'macos-latest'
    - name: Install Rust (macos)
      run: |
        curl https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      if: matrix.os == 'macos-latest'
    - run: cargo fetch
      working-directory: tools/witx
    - run: cargo test --all
      working-directory: tools/witx

  validate:
    name: Validate witx files and docs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Install Rust (rustup)
      shell: bash
      run: rustup update stable --no-self-update && rustup default stable

      # Install witx cli tool
    - run: cargo install --path cli
      working-directory: tools/witx

    - name: Check that docs reflect witx (Snapshot 1)
      run: witx docs --check ../../phases/snapshot/witx/wasi_snapshot_preview1.witx --output ../../phases/snapshot/docs.md
      working-directory: tools/witx
    - name: Check that docs reflect witx (Snapshot 0)
      run: witx docs --check ../../phases/old/snapshot_0/witx/wasi_unstable.witx --output ../../phases/old/snapshot_0/docs.md
      working-directory: tools/witx
    - name: Check that docs reflect witx (Ephemeral)
      run: >
        witx docs --check \
        ../../phases/ephemeral/witx/wasi_ephemeral_args.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_clock.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_environ.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_fd.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_path.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_poll.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_proc.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_random.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_sched.witx \
        ../../phases/ephemeral/witx/wasi_ephemeral_sock.witx \
        --output ../../phases/ephemeral/docs.md
      working-directory: tools/witx

  rustfmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Install Rust
      run: rustup update stable && rustup default stable && rustup component add rustfmt
    - run: cargo fmt -- --check
      working-directory: tools/witx
